**AskPDF** の開発を効率的に進めるため、4つのフェーズに分けた詳細仕様書を作成しました。プログラマーであるあなたの開発スタイルに合わせ、バックエンドの基盤構築からフロントエンドの高度なUI実装までを段階的に進められる構成にしています。

---

## Phase 1: 基盤構築（DB設計 & API統合）

まずはデータの永続化先であるSupabaseの構築と、既存の **Parser API** との接続を確立します。

### 1.1. データベース・ストレージ構築 (Supabase)

* **Vector DB**: `pgvector` 拡張を有効化し、`document_chunks` テーブルを作成します。
* **Storage**: PDF原本を保存する `pdfs` バケットを作成。
* **Schema**: チャンクテーブルには、検索用の `embedding` カラム（1536次元）と、ハイライト用の `metadata`（座標データ）を含めます。

### 1.2. App Backend (FastAPI) の基本実装

* **API Client**: 既存の Parser API を叩くための非同期クライアントの実装。
* **認証**: `X-API-Key` を用いた Parser API への安全なリクエスト。

---

## Phase 2: データ・インジェクション & RAGロジック

PDFをアップロードしてから、検索可能な状態にするまでのパイプラインを構築します。

### 2.1. インデックス・パイプライン

1. **Upload**: PDFをSupabase Storageへ保存。
2. **Parse**: Parser API の `POST /documents` へファイルを送信し `doc_id` を取得。
3. **Polling**: `GET /documents/{doc_id}` でステータスを監視（完了まで待機）。
4. **Fetch Chunks**: `POST /documents/{doc_id}/chunks` でベクトル付きチャンクと座標データを一括取得。
5. **Upsert**: 取得データを `document_chunks` テーブルへ保存。

### 2.2. ベクトル検索の実装

* **Search**: ユーザーの質問を `/embeddings` でベクトル化し、Supabase上の `match_documents`（コサイン類似度）関数で関連チャンクを抽出。

---

## Phase 3: フロントエンド & 自作PDFビューア

**AskPDF** の肝となる、3ペインUIとハイライト機能の実装フェーズです。

### 3.1. 3ペイン・レイアウト (Next.js)

* **左**: チャット履歴（PDF単位）の一覧。
* **中央**: 自作PDFビューア（レンダリング層 ＋ ハイライト用SVG/Div層）。
* **右**: チャット画面。

### 3.2. ハイライト・エンジンの実装

* **座標変換**: APIから取得したインチ単位の `bbox` を、ビューアの表示サイズに合わせたパーセンテージに変換します。

* **自動スクロール**: チャットの「根拠」をクリックした際、`Ref` を用いて該当の `Highlight` 要素まで `scrollIntoView` させるロジックを実装。

---

## Phase 4: 認証・ストリーミング・最適化

サービスとして公開するための仕上げと、ユーザー体験の向上を行います。

### 4.1. 会員管理と認可

* **Auth**: Supabase Auth を統合し、ログイン機能（Google/Email）を実装。
* **RLS (Row Level Security)**: 自分のPDFとチャット履歴のみにアクセスできるようDBポリシーを設定。

### 4.2. 回答のストリーミング化

* **WebSocket**: Parser API の `/ws/answers` を利用し、AIの回答をリアルタイムで生成・表示。
* **Usage Tracking**: トークン使用量を記録し、無料枠の制限機能を実装。

### 4.3. パフォーマンス最適化

* **キャッシュ**: 同一ドキュメントへの同一質問に対する回答をキャッシュ。
* **オーファン掃除**: Parser API側で自動削除されるファイルと、自社DB側の整合性を保つクリーンアップ処理の確認。

---

## 開発優先順位まとめ

| フェーズ | 重点目標 | 完了定義 |
| --- | --- | --- |
| **Phase 1** | インフラの疎通 | DBに手動でデータを入れ、検索ができる |
| **Phase 2** | 解析の自動化 | PDFを投げてから数分後にDBへチャンクが入る |
| **Phase 3** | UIの完成 | **PDF上の正しい位置が光る** |
| **Phase 4** | プロダクト化 | 会員登録ができ、履歴が残る |

